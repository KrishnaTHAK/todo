<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="styles.css">
    <title>G.O.A.T Todo App</title>
</head>

<body>
    
    <main class="todo-container">
        <header>
            <h1>Todo List</h1>
        </header>

        <section class="input-group">
            <input type="text" id="todo-input" placeholder="What needs to be done?">
            <button id="add-btn">Add ➕</button>
        </section>

        <ul id="todo-list">
            <li>
                <span>Tasks</span>
                <button class="delete-btn">❌</button>
            </li>
        </ul>
    </main>

    
    <script>

        function logout() {
            localStorage.removeItem('token');
            localStorage.removeItem('expiryTime');
            window.location.href='/login.html';
        }
            
        const token = localStorage.getItem('token');
        const expiryTime = localStorage.getItem('expiryTime');
        
        function checkAuth() {
            if(!token || !expiryTime){
                logout();
                return;
            }
            const currentTime = Date.now();
            const timeLeft = expiryTime - currentTime;
            if(timeLeft <= 0){
                alert('Session expired! Please login again.');
                logout();
            } else {
                console.log(`Session is valid!\n Auto-logout in ${Math.floor(timeLeft/1000)} seconds.`);
                setTimeout(()=>{
                    alert('Your session has expired!');
                    logout()
                }, timeLeft);
            }
        }
        
        checkAuth();

        if (!token) {
            window.location.href = './login.html';
        }

        const input = document.getElementById('todo-input');
        const addBtn = document.getElementById('add-btn');
        const list = document.getElementById('todo-list');

        
        window.onload = async () => {
            const response = await fetch('/todos', {
                headers: { 'token': token } // <--- CHANGE #1: Send Token
            });

            // If token is fake or expired, logout
            if (response.status === 401 || response.status === 403) {
                localStorage.removeItem('token');
                window.location.href = '/login.html';
                return;
            }

            const todos = await response.json();
            todos.forEach(todo => {
                addTodoToDOM(todo.id, todo.task);
            });
        };

        
        addBtn.addEventListener('click', async () => {
            const taskText = input.value;
            if (taskText === '') return alert("Please enter a task!");

            const response = await fetch('/todos', {
                method: 'POST',
                headers: { 
                    'Content-Type': 'application/json',
                    'token': token 
                },
                body: JSON.stringify({
                    task: taskText,
                    task_completed: false
                })
            });

            
            const savedTodoID = response.json();

            
            addTodoToDOM(savedTodoID.id, taskText);
            input.value = '';
        });


        
        function addTodoToDOM(id, task) {
            const li = document.createElement('li');
            li.id = `todo-${id}`;
            li.innerHTML = `
                <span>${task}</span>
                <button class="delete-btn" onclick="deleteTodo(${id})">Delete</button>
            `;
            list.appendChild(li);
        }
        
        async function deleteTodo(id) {
            await fetch(`/todos/${id}`, {
                method: 'DELETE',
                headers: { 'token': token } // <--- CHANGE #3: Send Token
            });

            document.getElementById(`todo-${id}`).remove();
        }
    
    </script>   

</body>

</html>